#Use an Ubuntu 18.04 base for our staging server
FROM vm/ubuntu:18.04

# To note: Layerfiles create entire VMs, *not* containers!

# install rails dependencies
RUN curl -fSsL https://deb.nodesource.com/setup_12.x | bash && \
    curl -fSsL https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - && \
    echo "deb https://dl.yarnpkg.com/debian/ stable main" > /etc/apt/sources.list.d/yarn.list && \
    apt-get update && \
    apt-get install git-core zlib1g-dev build-essential libssl-dev \
    libreadline-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt1-dev \
    libcurl4-openssl-dev software-properties-common libffi-dev nodejs yarn

# Install ruby
RUN git clone https://github.com/rbenv/rbenv.git ~/.rbenv
ENV PATH=$HOME/.rbenv/bin:$PATH
RUN echo 'eval "$(rbenv init -)"' >> ~/.bashrc

RUN git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
RUN echo 'export PATH="$HOME/.rbenv/plugins/ruby-build/bin:$PATH"' >> ~/.bashrc

RUN rbenv install 2.7.1
RUN rbenv global 2.7.1
ENV PATH=$HOME/.rbenv/versions/2.7.1/bin:$PATH
RUN echo Using ruby version: `ruby -v`

# This line copies the repository to /root in the runner
COPY . .
RUN ls

# Install bundler and let bundler install dependencies
RUN gem install bundler
RUN bundle install

# Set up environment variables for Coveralls
ENV CI_NAME=layerci \
   CI_BUILD_NUMBER=$LAYERCI_JOB_ID \
   CI_BUILD_URL="https://layerci.com/$LAYERCI_ORG_NAME/commits?query=repo%3A$LAYERCI_REPO_NAME+id%3A$LAYERCI_JOB_ID" \
   CI_BRANCH="$LAYERCI_BRANCH" \
   CI_PULL_REQUEST="$LAYERCI_PULL_REQUEST"

SECRET ENV COVERALLS_REPO_TOKEN

# Run rspec tests - This command also sends coverage to Coveralls because we're using the coveralls-ruby integration for Ruby projects
# coveralls-ruby hooks into your call to rspec and sends coverage to https://coveralls.io/api/v1.jobs on your behalf
RUN bundle exec rspec
